# ChatGptServiceã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã€OpenAI APIã‚’ä½¿ã£ã¦ã€ç”»åƒã‹ã‚‰ä½œç‰©æƒ…å ±ã‚’æŠ½å‡º
class ChatGptService
  # DBã‹ã‚‰ä½œç‰©åã‚’å‹•çš„ã«å–å¾—ã—ã¦æ–‡å­—åˆ—ã«ã™ã‚‹
  def allowed_crops
    @allowed_crops ||= Crop.distinct.pluck(:name).join(" / ")
  end

  # OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹ã€initializeãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆ
  def initialize
    @client = OpenAI::Client.new(access_token: ENV['OPENAI_API_KEY'])
  end

  # image_url: è§£æã™ã‚‹ç”»åƒã®URL
  def analyze_crop_image(image_url)
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
    prompt = <<~PROMPT
      ## å‡ºå“ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
      - å•†å“åã¯æ¶ˆè²»è€…ãŒæ€ã‚ãšè²·ã„ãŸããªã‚‹ 15ã€œ50æ–‡å­—ç¨‹åº¦ã§ã®ã‚­ãƒ£ãƒƒãƒãƒ¼ãªå•†å“åã‚’è€ƒãˆã¦ãã ã•ã„(ä¾‹ï¼šã€æœŸé–“é™å®šâ€¼ï¸ã€6ãƒ¶æœˆç†Ÿæˆã€ç´…ã¯ã‚‹ã‹ğŸ  ã—ã£ã¨ã‚Šã¨ã—ãŸé£Ÿæ„Ÿã¨çµ¶å¦™ãªç”˜ã•ãŒãŸã¾ã‚Šã¾ã›ã‚“ï¼ã“ã®æ©Ÿä¼šã«ãœã²â€¼ï¸)
      - ä½œç‰©åã¯å¿…ãšæ¬¡ã®ãƒªã‚¹ãƒˆã®ä¸­ã‹ã‚‰1ã¤ã ã‘é¸ã‚“ã§ãã ã•ã„
        #{allowed_crops}
      - å“ç¨®åã¯ç”»åƒã‹ã‚‰è€ƒãˆã‚‰ã‚Œã‚‹å€™è£œã‚’ **2ã€œ5ä»¶**ã€**åŠè§’ã‚«ãƒ³ãƒ(, )åŒºåˆ‡ã‚Š** ã§å¿…ãšåˆ—æŒ™ã—ã¦ãã ã•ã„
      - ç©ºæ¬„ã¯ç¦æ­¢ã€‚ç”»åƒã‹ã‚‰ç‰¹å®šå›°é›£ã§ã‚‚ã€è©²å½“ä½œç‰©ã§ä¸€èˆ¬çš„ãªä¸»è¦å“ç¨®ã‹ã‚‰**æ¨æ¸¬å€™è£œ**ã‚’æœ€ä½2ä»¶å¿…ãšæç¤ºã—ã¦ãã ã•ã„
      - ä½œç‰©ã¨ç„¡é–¢ä¿‚ãªå“ç¨®åã¯å‡ºã•ãªã„ã§ãã ã•ã„
      - ç”£åœ°ã¯ä½œç‰©åã«ç´ã¥ãç”£åœ°ã®ã†ã¡ä¸€ã¤æ¡ç”¨ã—ã¦ãã ã•ã„
      - åç©«æ—¥ã¯ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæ—¥ã‚’æ¡ç”¨ã—ã¦ãã ã•ã„ã€‚ä¸æ˜ãªå ´åˆã¯ã€Œ#{Time.zone.today.strftime('%Y-%m-%d')}ã€ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
      - ä¾¡æ ¼ã¯æ—¥æœ¬å›½å†…ã®ç›´è¿‘ã®ç›¸å ´ã‚’å‚è€ƒã«1kgå˜ä¾¡å½¢å¼ã§æ¨å®šã—ã¦ãã ã•ã„
      - å®¹é‡ã¯åˆæœŸå€¤ã¨ã—ã¦1ã¨ã—ã¦ãã ã•ã„(æ•°å­—ã®ã¿)
      - å—ã‘å–ã‚Šæ‰€ã¯ç™»éŒ²ã—ã¦ã‚ã‚‹å…ˆé ­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
      - å•†å“èª¬æ˜ã¯80ã€œ150æ–‡å­—ç¨‹åº¦ã§ã€ãã®ä½œç‰©ã®ç‰¹å¾´ãƒ»é®®åº¦ãƒ»ãŠã™ã™ã‚ã®é£Ÿã¹æ–¹ã€ã“ã ã‚ã‚Šã‚„ç”Ÿç”£æ–¹æ³•ãªã©PRã‚’è€ƒãˆã¦ææ¡ˆã—ã¦ãã ã•ã„ï¼ˆçµµæ–‡å­—ã‚‚æ´»ç”¨ã—ã€æ®µè½ã‚’åˆ†ã‘ã¦è¦‹ã‚„ã™ãï¼‰

      ## ç”»åƒã‹ã‚‰ã®å“è³ªåˆ¤å®šãƒ«ãƒ¼ãƒ«
      - æ‰“æ’²ãƒ»å¤‰è‰²ãƒ»é»’æ–‘ãƒ»å‚·ãƒ»è£‚ã‘ãƒ»è…ã‚Œã€è‘—ã—ã„å½¢ã®ä¹±ã‚Œã€ã‚«ãƒ“ã€æ±æ¼ã‚Œç­‰ãŒæ˜ç­ã«è¦‹ã‚‰ã‚Œã‚‹ â†’ **Bå“ï¼ˆè¨³ã‚ã‚Šï¼‰**
      - ä¸Šè¨˜ãŒè¦‹ã‚‰ã‚Œãªã‘ã‚Œã° **Aå“**
      - Bå“ã®ã¨ãã¯ã€å•†å“åã«ã€Œã€è¨³ã‚ã‚ŠBå“ã€‘ã€ç­‰ã‚’å«ã‚ã€èª¬æ˜ã®å‰åŠã§å‰å‘ãã«â€œå®¶åº­ç”¨ã«æœ€é©/åŠ å·¥ç”¨ã«ãŠã™ã™ã‚â€ç­‰ã‚‚æ˜è¨˜ã—ã€é›£ç‚¹ã‚’1ã€œ2ç‚¹ã ã‘ç°¡æ½”ã«è¨˜è¼‰

      ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå³å®ˆï¼šä»¥ä¸‹ã®è¡Œã ã‘ã‚’ã“ã®é †ã§å‡ºåŠ›ï¼‰
      å•†å“å: <å•†å“å> # Bå“ã¯ã€Œã€è¨³ã‚ã‚ŠBå“ã€‘ã€ç­‰ã‚’å«ã‚ã‚‹
      ä½œç‰©å: <ä½œç‰©å>
      å“ç¨®å: <å“ç¨®å€™è£œã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§åˆ—æŒ™(ç„¡ã‘ã‚Œã°ä¸æ˜)>
      ç”£åœ°: <ç”£åœ°(ä½œç‰©ã«ç´ã¥ãç”£åœ°ã‚’å‚ç…§)>
      åç©«æ—¥: <YYYY-MM-DD>
      å®¹é‡: <å®¹é‡ã®åˆæœŸå€¤ã¯1ã¨ã™ã‚‹>
      ä¾¡æ ¼: <1kgã‚ãŸã‚Šã®æ¨å®šä¾¡æ ¼>
      ç­‰ç´š: <A ã¾ãŸã¯ B>
      çŠ¶æ…‹: <Bå“ã®ã¨ãã®é›£ç‚¹ãƒ¡ãƒ¢ã€‚Aå“ã¯ç§€å“ã¨ã™ã‚‹>
      å—ã‘å–ã‚Šæ‰€: <ç”Ÿç”£è€…ãŒç™»éŒ²ã—ãŸå…ˆé ­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨>
      å•†å“èª¬æ˜: <80ã€œ150æ–‡å­—ã®èª¬æ˜ï¼ˆBå“ã¯è¨³ã‚ã‚Šã®å‰å‘ãèª¬æ˜ã‚’å«ã‚ã‚‹ï¼‰>
    PROMPT

    response = @client.chat(
      parameters: {
        model: "gpt-4o",
        messages: [
          {
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦APIã«é€ä¿¡
            role: "user",
            content: [
              {
                # ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                type: "text",
                text: prompt
              },
              {
                # ç”»åƒURLã‚’æŒ‡å®š
                type: "image_url",
                image_url: { url: image_url }
              }
            ]
          }
        ],
        # è¿”ç­”ã®æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°(å›ç­”ãŒé•·ã™ããªã„ã‚ˆã†ã«ä¸Šé™ã‚’è¨­å®š)
        max_tokens: 1000
      }
    )

    # APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰è§£ç­”ã®æœ¬æ–‡ã‚’å–ã‚Šå‡ºã™
    # choices[0].message.contentã«å›ç­”ãŒå…¥ã£ã¦ã„ã‚‹
    content = response.dig("choices", 0, "message", "content")
    return { error: "no_response" } if content.blank?

    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ä½œç‰©åã¨å“ç¨®åã‚’æ­£è¦è¡¨ç¾ã§æŠ½å‡º
    {
      product_name: content[/å•†å“å[:ï¼š]?\s*(.+)/, 1],
      name: content[/ä½œç‰©å[:ï¼š]?\s*(.+)/, 1],
      variety: content[/å“ç¨®å[:ï¼š]?\s*(.+)/, 1],
      producing_area: content[/ç”£åœ°[:ï¼š]?\s*(.+)/, 1],
      harvest_day: content[/åç©«æ—¥[:ï¼š]?\s*(.+)/, 1],
      capacity: content[/å®¹é‡[:ï¼š]?\s*(.+)/, 1],
      price: content[/ä¾¡æ ¼[:ï¼š]?\s*(.+)/, 1],
      grade: content[/ç­‰ç´š[:ï¼š]?\s*([AB])/, 1],
      condition: content[/çŠ¶æ…‹[:ï¼š]?\s*(.+)/, 1],
      receiving_point_name: content[/å—ã‘å–ã‚Šæ‰€[:ï¼š]?\s*(.+)/, 1],
      description: content[/å•†å“èª¬æ˜[:ï¼š]?\s*(.+)/, 1],
      raw: content
    }
  end
end
