# ChatGptServiceã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã€OpenAI APIã‚’ä½¿ã£ã¦ã€ç”»åƒã‹ã‚‰ä½œç‰©æƒ…å ±ã‚’æŠ½å‡º
class ChatGptService
  # DBã‹ã‚‰ä½œç‰©åã‚’å‹•çš„ã«å–å¾—ã—ã¦æ–‡å­—åˆ—ã«ã™ã‚‹
  def allowed_crops
    @allowed_crops ||= Crop.distinct.pluck(:name).join(" / ")
  end

  # OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹ã€initializeãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆ
  def initialize
    @client = OpenAI::Client.new(access_token: ENV['OPENAI_API_KEY'])
  end

  # image_url: è§£æã™ã‚‹ç”»åƒã®URL
  def analyze_crop_image(image_url)
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
    prompt = <<~PROMPT
      ## å‡ºå“ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
      - å•†å“åã¯æ¶ˆè²»è€…ãŒæ€ã‚ãšè²·ã„ãŸããªã‚‹ 15ã€œ50æ–‡å­—ç¨‹åº¦ã§ã®ã‚­ãƒ£ãƒƒãƒãƒ¼ãªå•†å“åã‚’è€ƒãˆã¦ãã ã•ã„(ä¾‹ï¼šã€æœŸé–“é™å®šâ€¼ï¸ã€6ãƒ¶æœˆç†Ÿæˆã€ç´…ã¯ã‚‹ã‹ğŸ  ã—ã£ã¨ã‚Šã¨ã—ãŸé£Ÿæ„Ÿã¨çµ¶å¦™ãªç”˜ã•ãŒãŸã¾ã‚Šã¾ã›ã‚“ï¼ã“ã®æ©Ÿä¼šã«ãœã²â€¼ï¸)
      - ä½œç‰©åã¯å¿…ãšæ¬¡ã®ãƒªã‚¹ãƒˆã®ä¸­ã‹ã‚‰1ã¤ã ã‘é¸ã‚“ã§ãã ã•ã„
        #{allowed_crops}
      - å“ç¨®åã¯ç”»åƒã§ã¯èªè­˜ã—ã¥ã‚‰ã„ã¨æ€ã†ã®ã§ã€åˆ†ã‹ã‚‰ãªã‘ã‚Œã°ç©ºæ¬„ã§OKã§ã™ã€‚åˆ†ã‹ã‚‹å ´åˆã®ã¿è¨˜è¼‰ã—ã¦ãã ã•ã„
      - ä¾¡æ ¼ã¯æ—¥æœ¬å›½å†…ã®ç›´è¿‘ã®ç›¸å ´ã‚’å‚è€ƒã«1kgå˜ä¾¡å½¢å¼ã§æ¨å®šã—ã¦ãã ã•ã„
      - å•†å“èª¬æ˜ã¯80ã€œ150æ–‡å­—ç¨‹åº¦ã§ã€ãã®ä½œç‰©ã®ç‰¹å¾´ãƒ»é®®åº¦ãƒ»ãŠã™ã™ã‚ã®é£Ÿã¹æ–¹ã€ã“ã ã‚ã‚Šã‚„ç”Ÿç”£æ–¹æ³•ãªã©PRã‚’è€ƒãˆã¦ææ¡ˆã—ã¦ãã ã•ã„(æ–‡ã ã‘ã§ã¯ãªãçµµæ–‡å­—ã‚‚æ´»ç”¨ã—ã€æ®µè½ã‚’åˆ†ã‘è¦‹ã‚„ã™ã„ã‚ˆã†ã«ã€ã¾ãŸè¦‹ã‚‹äººãŒè³¼å…¥ã—ãŸã„ã¨æ€ãˆã‚‹ã‚ˆã†ã«ãƒ—ãƒ¬ã‚¼ãƒ³ã—ã¦ãã ã•ã„)

      ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ(å³å®ˆ)
      å•†å“å: <å•†å“å>
      ä½œç‰©å: <ä½œç‰©å>
      ä¾¡æ ¼: <ä¾¡æ ¼>
      å•†å“èª¬æ˜: <èª¬æ˜>
    PROMPT

    response = @client.chat(
      parameters: {
        model: "gpt-4o",
        messages: [
          {
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦APIã«é€ä¿¡
            role: "user",
            content: [
              {
                # ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                type: "text",
                text: prompt
              },
              {
                # ç”»åƒURLã‚’æŒ‡å®š
                type: "image_url",
                image_url: { url: image_url }
              }
            ]
          }
        ],
        # è¿”ç­”ã®æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°(å›ç­”ãŒé•·ã™ããªã„ã‚ˆã†ã«ä¸Šé™ã‚’è¨­å®š)
        max_tokens: 1000
      }
    )

    # APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰è§£ç­”ã®æœ¬æ–‡ã‚’å–ã‚Šå‡ºã™
    # choices[0].message.contentã«å›ç­”ãŒå…¥ã£ã¦ã„ã‚‹
    content = response.dig("choices", 0, "message", "content")
    return { error: "no_response" } if content.blank?

    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ä½œç‰©åã¨å“ç¨®åã‚’æ­£è¦è¡¨ç¾ã§æŠ½å‡º
    {
      product_name: content[/å•†å“å[:ï¼š]?\s*(.+)/, 1],
      name: content[/ä½œç‰©å[:ï¼š]?\s*(.+)/, 1],
      variety: content[/å“ç¨®å[:ï¼š]?\s*(.+)/, 1],
      price: content[/ä¾¡æ ¼[:ï¼š]?\s*(.+)/, 1],
      description: content[/å•†å“èª¬æ˜[:ï¼š]?\s*(.+)/, 1],
      raw: content
    }
  end
end
